<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ngomani's Scientific Calculator</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Enable horizontal scrolling on the screen container */
        .screen {
            overflow-x: auto;
        }
        /* Make the calculator screen's input wide and nowrap */
        #calc-screen {
            width: 100%;
            white-space: nowrap;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="calculator">
        <!-- Screen -->
        <div class="screen">
            <input type="text" id="calc-screen" readonly value="0">
        </div>
        <!-- Keys Container -->
        <div class="keys">
            <!-- Top Keys Row -->
            <div class="row top-keys">
                <button id="second-toggle" class="shift">2ndF</button>
                <button class="alpha">ALPHA</button>
                <button>MCL</button>
                <button>RCL</button>
                <button class="red">Del</button>
                <button class="red">AC</button>
            </div>
            <!-- Function Keys Row -->
            <div class="row function-keys">
                <button>hyp</button>
                <button class="dual" data-primary="sin" data-secondary="sin⁻¹">sin</button>
                <button class="dual" data-primary="cos" data-secondary="cos⁻¹">cos</button>
                <button class="dual" data-primary="tan" data-secondary="tan⁻¹">tan</button>
                <button>x²</button>
                <button>x³</button>
                <button class="dual" data-primary="√" data-secondary="∛">√</button>
                <button class="dual" data-primary="log" data-secondary="ln">log</button>
                <button class="dual" data-primary="10^x" data-secondary="e^x">10^x</button>
                <button class="dual" data-primary="1/x" data-secondary="Ran#">1/x</button>
            </div>
            <!-- Bottom Keys Row (Numpad & Operators) -->
            <div class="row bottom-keys">
                <table>
                    <tr>
                        <td><button>7</button></td>
                        <td><button>8</button></td>
                        <td><button>9</button></td>
                        <td><button class="operator">+</button></td>
                        <td><button class="operator">-</button></td>
                    </tr>
                    <tr>
                        <td><button>4</button></td>
                        <td><button>5</button></td>
                        <td><button>6</button></td>
                        <td><button class="operator">×</button></td>
                        <td><button class="operator">÷</button></td>
                    </tr>
                    <tr>
                        <td><button>1</button></td>
                        <td><button>2</button></td>
                        <td><button>3</button></td>
                        <td><button class="operator">(</button></td>
                        <td><button class="operator">)</button></td>
                    </tr>
                    <tr>
                        <td><button>0</button></td>
                        <td><button>00</button></td>
                        <td><button id="dot-btn">.</button></td>
                        <td><button id="ans-btn">ANS</button></td>
                        <td><button id="xpowery-btn">x^y</button></td>
                    </tr>
                </table>
            </div>
            <!-- Equals Row -->
            <div class="row equals-row">
                <button class="equal wide">=</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for handling input, evaluation, scrolling, and 2ndF toggling -->
<script>
    // Global variables
    let lastAns = "";
    let isSecondFunction = false; // flag for dual button toggle
    let evaluated = false; // flag to indicate if the last action was an evaluation

    // Globals for square root mode:
    let sqrtMode = false;      // true if entering a square/cube root radicand
    let sqrtRadicand = "";     // stores the current radicand
    let currentRoot = "";      // will be "√" for square root or "∛" for cube root

    // New globals for exponent mode:
    let expMode = false;       // true if entering an exponent after x^y
    let expExponent = "";      // stores the exponent digits

    // Function to update horizontal scroll of the screen.
    function updateScroll() {
        const screenElem = document.getElementById('calc-screen');
        screenElem.scrollLeft = screenElem.scrollWidth;
    }

    // Helper: add a combining overline (U+0305) after each character to simulate a roof.
    function addOverline(str) {
        return str.split('').map(c => c + "\u0305").join('');
    }

    // Helper: remove combining overline characters.
    function removeOverline(str) {
        return str.replace(/\u0305/g, "");
    }

    // Toggle 2nd function on dual keys when 2ndF is pressed.
    document.getElementById("second-toggle").addEventListener("click", function(e){
        isSecondFunction = !isSecondFunction;
        document.querySelectorAll(".dual").forEach(function(btn) {
            btn.innerText = isSecondFunction ? btn.getAttribute("data-secondary") : btn.getAttribute("data-primary");
        });
        e.stopPropagation();
    });

    // Add event listeners to all buttons (except the equal button and the 2ndF toggle).
    document.querySelectorAll('.keys button:not(.equal)').forEach(function(button) {
        button.addEventListener('click', function(e) {
            if(this.id === "second-toggle") return;
            const btnText = this.innerText;
            const screen = document.getElementById('calc-screen');

            // If an evaluation just occurred and a number (or dot) is pressed, clear the screen.
            if(evaluated && /^[0-9.]$/.test(btnText)) {
                screen.value = "";
                evaluated = false;
                // Also cancel any active sqrt or exponent mode.
                if(sqrtMode) { sqrtMode = false; sqrtRadicand = ""; currentRoot = ""; }
                if(expMode) { expMode = false; expExponent = ""; }
            } else {
                evaluated = false;
            }

            // If square root mode is active and a digit/dot is pressed, update the radicand.
            if(sqrtMode && /^[0-9.]$/.test(btnText)) {
                sqrtRadicand += btnText;
                let idx = screen.value.lastIndexOf(currentRoot);
                if(idx !== -1) {
                    screen.value = screen.value.slice(0, idx + currentRoot.length) + addOverline(sqrtRadicand);
                } else {
                    screen.value += addOverline(sqrtRadicand);
                }
                updateScroll();
                return;
            }
            // If square root mode is active and a non-digit is pressed, close the sqrt expression.
            if(sqrtMode && !/^[0-9.]$/.test(btnText)) {
                screen.value += ")";
                sqrtMode = false;
            }

            // If exponent mode is active and a digit/dot is pressed, update the exponent.
            if(expMode && /^[0-9.]$/.test(btnText)) {
                expExponent += btnText;
                let idx = screen.value.lastIndexOf("^-");
                if(idx !== -1) {
                    screen.value = screen.value.slice(0, idx) + "^-" + expExponent;
                } else {
                    screen.value += "^-" + expExponent;
                }
                updateScroll();
                return;
            }
            // If exponent mode is active and a non-digit is pressed, close exponent mode.
            if(expMode && !/^[0-9.]$/.test(btnText)) {
                if(expExponent === "") expExponent = "0";
                expMode = false;
            }

            if (btnText === "AC") {
                screen.value = "0";
            } else if (btnText === "Del") {
                if(screen.value.length > 0) {
                    screen.value = screen.value.slice(0, -1);
                }
                if(screen.value === "") screen.value = "0";
            } else if (btnText === "ANS") {
                if(lastAns !== "") {
                    let formattedAns = String(lastAns).replace(/^0+/, '');
                    if(formattedAns === "") { formattedAns = "0"; }
                    screen.value = formattedAns;
                }
            } else if (btnText === "x²") {
                let currentVal = screen.value;
                let regex = /(\d+(\.\d+)?)(?!.*\d)/;
                let match = currentVal.match(regex);
                if(match) {
                    let numberStr = match[0];
                    screen.value = currentVal.slice(0, match.index) + numberStr + "²";
                }
            } else if (btnText === "x³") {
                let currentVal = screen.value;
                let regex = /(\d+(\.\d+)?)(?!.*\d)/;
                let match = currentVal.match(regex);
                if(match) {
                    let numberStr = match[0];
                    screen.value = currentVal.slice(0, match.index) + numberStr + "³";
                }
            } else if (btnText === "x^y") {
                // Start exponent mode.
                if(screen.value === "0") { screen.value = ""; }
                expMode = true;
                expExponent = "";
                // Append the exponent template: a caret and a dash ("^-")
                screen.value += "^-";
                updateScroll();
                return;
            } else if (btnText === "√" || btnText === "∛") {
                if(screen.value === "0") { screen.value = ""; }
                sqrtMode = true;
                sqrtRadicand = "";
                currentRoot = btnText; // "√" or "∛"
                screen.value += currentRoot;
            } else if (btnText === "sin" || btnText === "sin⁻¹") {
                if(screen.value === "0") { screen.value = ""; }
                if(btnText === "sin") {
                    screen.value += "sin(";
                } else {
                    screen.value += "asin(";
                }
            } else if (btnText === "cos") {
                if(screen.value === "0") { screen.value = ""; }
                screen.value += "cos(";
            } else if (btnText === "tan") {
                if(screen.value === "0") { screen.value = ""; }
                screen.value += "tan(";
            } else {
                if(screen.value === "0") { screen.value = ""; }
                screen.value += btnText;
            }
            updateScroll();
        });
    });

    // Evaluate the expression when the equal button is clicked.
    document.querySelector('.equal').addEventListener('click', function() {
        const screen = document.getElementById('calc-screen');
        let expression = screen.value;
        if(sqrtMode) {
            expression += ")";
            sqrtMode = false;
        }
        if(expMode) {
            if(expExponent === "") expExponent = "0";
            expMode = false;
        }
        // Replace our sqrt/∛ notation with Math.sqrt/Math.cbrt calls.
        expression = expression.replace(/(√|∛)([0-9\u0305\.]+)\)/g, function(match, rootSymbol, radicand) {
            let plainRadicand = radicand.replace(/\u0305/g, "");
            return (rootSymbol === "√" ? "Math.sqrt(" : "Math.cbrt(") + plainRadicand + ")";
        });
        // Replace exponent mode markers: replace "^-<exponent>" with "**<exponent>"
        expression = expression.replace(/\^\-([0-9\.]+)/g, function(match, expVal) {
            return "**" + expVal;
        });
        // Replace trigonometric functions with Math. functions.
        expression = expression.replace(/asin\(/g, "Math.asin(")
            .replace(/sin\(/g, "Math.sin(")
            .replace(/cos\(/g, "Math.cos(")
            .replace(/tan\(/g, "Math.tan(");
        // Replace other symbols.
        expression = expression.replace(/×/g, '*')
            .replace(/÷/g, '/')
            .replace(/x\^y/g, '**')
            .replace(/²/g, "**2")
            .replace(/³/g, "**3");

        try {
            const result = eval(expression);
            if (!isFinite(result)) {
                screen.value = "Error";
                lastAns = "";
            } else {
                screen.value = result;
                lastAns = result;
            }
        } catch(e) {
            screen.value = "Error";
            lastAns = "";
        }
        evaluated = true;
        updateScroll();
    });
</script>
</body>
</html>
