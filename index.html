<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ngomani's Scientific Calculator</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Enable horizontal scrolling on the screen container */
        .screen {
            overflow-x: auto;
        }
        /* Make the calculator screen's input wide and nowrap */
        #calc-screen {
            width: 100%;
            white-space: nowrap;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="calculator">
        <!-- Screen -->
        <div class="screen">
            <input type="text" id="calc-screen" readonly value="0">
        </div>
        <!-- Keys Container -->
        <div class="keys">
            <!-- Top Keys Row -->
            <div class="row top-keys">
                <button id="second-toggle" class="shift">2ndF</button>
                <button class="alpha">ALPHA</button>
                <button>MCL</button>
                <button>RCL</button>
                <button class="red">Del</button>
                <button class="red">AC</button>
            </div>
            <!-- Function Keys Row -->
            <div class="row function-keys">
                <button>hyp</button>
                <button class="dual" data-primary="sin" data-secondary="sin⁻¹">sin</button>
                <button class="dual" data-primary="cos" data-secondary="cos⁻¹">cos</button>
                <button class="dual" data-primary="tan" data-secondary="tan⁻¹">tan</button>
                <button>x²</button>
                <button>x³</button>
                <button class="dual" data-primary="√" data-secondary="∛">√</button>
                <button class="dual" data-primary="log" data-secondary="ln">log</button>
                <button class="dual" data-primary="10^x" data-secondary="e^x">10^x</button>
                <button class="dual" data-primary="1/x" data-secondary="Ran#">1/x</button>
            </div>
            <!-- Bottom Keys Row (Numpad & Operators) -->
            <div class="row bottom-keys">
                <table>
                    <tr>
                        <td><button>7</button></td>
                        <td><button>8</button></td>
                        <td><button>9</button></td>
                        <td><button class="operator">+</button></td>
                        <td><button class="operator">-</button></td>
                    </tr>
                    <tr>
                        <td><button>4</button></td>
                        <td><button>5</button></td>
                        <td><button>6</button></td>
                        <td><button class="operator">×</button></td>
                        <td><button class="operator">÷</button></td>
                    </tr>
                    <tr>
                        <td><button>1</button></td>
                        <td><button>2</button></td>
                        <td><button>3</button></td>
                        <td><button class="operator">(</button></td>
                        <td><button class="operator">)</button></td>
                    </tr>
                    <tr>
                        <td><button>0</button></td>
                        <td><button>00</button></td>
                        <td><button id="dot-btn">.</button></td>
                        <td><button id="ans-btn">ANS</button></td>
                        <td><button id="xpowery-btn">x^y</button></td>
                    </tr>
                </table>
            </div>
            <!-- Equals Row -->
            <div class="row equals-row">
                <button class="equal wide">=</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for handling input, evaluation, scrolling, and 2ndF toggling -->
<script>
    // Global variables
    let lastAns = "";
    let isSecondFunction = false; // flag for dual button toggle
    let evaluated = false; // indicates if the last action was an evaluation

    // Globals for square root mode:
    let sqrtMode = false;      // true if entering a square/cube root radicand
    let sqrtRadicand = "";     // stores the current radicand
    let currentRoot = "";      // will be "√" for square root or "∛" for cube root

    // Globals for exponent mode:
    let expMode = false;       // true if entering an exponent after x^y
    let expExponent = "";      // stores the exponent digits
    let baseExp = "";          // stores the base number for exponentiation
    let expCursorVisible = false; // for blinking cursor
    let expCursorInterval;       // timer for blinking

    // Helper: mapping for superscript conversion.
    const supMap = {
        "0": "⁰", "1": "¹", "2": "²", "3": "³", "4": "⁴",
        "5": "⁵", "6": "⁶", "7": "⁷", "8": "⁸", "9": "⁹", ".": "."
    };
    function toSuperscript(str) {
        return str.split('').map(c => supMap[c] || c).join('');
    }
    function fromSuperscript(str) {
        const revMap = {"⁰": "0", "¹": "1", "²": "2", "³": "3", "⁴": "4",
            "⁵": "5", "⁶": "6", "⁷": "7", "⁸": "8", "⁹": "9", ".": "."};
        return str.split('').map(c => revMap[c] || c).join('');
    }

    // Helper for square root mode:
    function addOverline(str) {
        return str.split('').map(c => c + "\u0305").join('');
    }
    function removeOverline(str) {
        return str.replace(/\u0305/g, "");
    }

    // Update horizontal scroll.
    function updateScroll() {
        const screenElem = document.getElementById('calc-screen');
        screenElem.scrollLeft = screenElem.scrollWidth;
    }

    // Exponent blinking cursor functions.
    function startExpCursor() {
        expCursorVisible = true;
        expCursorInterval = setInterval(toggleExpCursor, 500);
    }
    function toggleExpCursor() {
        expCursorVisible = !expCursorVisible;
        updateExpDisplay();
    }
    function stopExpCursor() {
        clearInterval(expCursorInterval);
        expCursorVisible = false;
        updateExpDisplay();
    }
    function updateExpDisplay() {
        const screen = document.getElementById('calc-screen');
        // Build display: baseExp followed by raised exponent and if cursor is active, a blinking underscore.
        let cursor = expCursorVisible ? toSuperscript("_") : "";
        screen.value = baseExp + toSuperscript(expExponent) + cursor;
    }

    // Toggle 2nd function.
    document.getElementById("second-toggle").addEventListener("click", function(e){
        isSecondFunction = !isSecondFunction;
        document.querySelectorAll(".dual").forEach(function(btn) {
            btn.innerText = isSecondFunction ? btn.getAttribute("data-secondary") : btn.getAttribute("data-primary");
        });
        e.stopPropagation();
    });

    // Main button event listeners.
    document.querySelectorAll('.keys button:not(.equal)').forEach(function(button) {
        button.addEventListener('click', function(e) {
            if(this.id === "second-toggle") return;
            const btnText = this.innerText;
            const screen = document.getElementById('calc-screen');

            // If evaluation just occurred and a digit/dot is pressed, clear the screen.
            if(evaluated && /^[0-9.]$/.test(btnText)) {
                screen.value = "";
                evaluated = false;
                if(sqrtMode) { sqrtMode = false; sqrtRadicand = ""; currentRoot = ""; }
                if(expMode) { stopExpCursor(); expMode = false; expExponent = ""; baseExp = ""; }
            } else {
                evaluated = false;
            }

            // Exponent mode: if active and digit/dot is pressed, update exponent.
            if(expMode && /^[0-9.]$/.test(btnText)) {
                expExponent += btnText;
                updateExpDisplay();
                updateScroll();
                return;
            }
            // If exponent mode active and non-digit is pressed, close exponent mode.
            if(expMode && !/^[0-9.]$/.test(btnText)) {
                stopExpCursor();
                expMode = false;
            }

            // Square root mode: if active and digit/dot is pressed, update radicand.
            if(sqrtMode && /^[0-9.]$/.test(btnText)) {
                sqrtRadicand += btnText;
                let idx = screen.value.lastIndexOf(currentRoot);
                if(idx !== -1) {
                    screen.value = screen.value.slice(0, idx + currentRoot.length) + addOverline(sqrtRadicand);
                } else {
                    screen.value += addOverline(sqrtRadicand);
                }
                updateScroll();
                return;
            }
            if(sqrtMode && !/^[0-9.]$/.test(btnText)) {
                screen.value += ")";
                sqrtMode = false;
            }

            if (btnText === "AC") {
                screen.value = "0";
            } else if (btnText === "Del") {
                if(screen.value.length > 0) {
                    screen.value = screen.value.slice(0, -1);
                }
                if(screen.value === "") screen.value = "0";
            } else if (btnText === "ANS") {
                if(lastAns !== "") {
                    let formattedAns = String(lastAns).replace(/^0+/, '');
                    if(formattedAns === "") { formattedAns = "0"; }
                    screen.value = formattedAns;
                }
            } else if (btnText === "sin" || btnText === "sin⁻¹") {
                if(screen.value === "0") { screen.value = ""; }
                screen.value += (btnText === "sin" ? "sin(" : "asin(");
            } else if (btnText === "cos") {
                if(screen.value === "0") { screen.value = ""; }
                screen.value += "cos(";
            } else if (btnText === "tan") {
                if(screen.value === "0") { screen.value = ""; }
                screen.value += "tan(";
            } else if (btnText === "x²") {
                let currentVal = screen.value;
                let regex = /(\d+(\.\d+)?)(?!.*\d)/;
                let match = currentVal.match(regex);
                if(match) {
                    let numberStr = match[0];
                    screen.value = currentVal.slice(0, match.index) + numberStr + "²";
                }
            } else if (btnText === "x³") {
                let currentVal = screen.value;
                let regex = /(\d+(\.\d+)?)(?!.*\d)/;
                let match = currentVal.match(regex);
                if(match) {
                    let numberStr = match[0];
                    screen.value = currentVal.slice(0, match.index) + numberStr + "³";
                }
            }
            // x^y branch.
            else if (btnText === "x^y") {
                // If already in exponent mode, finalize the exponent input.
                if(expMode) {
                    stopExpCursor();
                    expMode = false;
                    // The raised exponent remains; subsequent keys will be appended at the baseline.
                    return;
                }
                // Otherwise, begin exponent mode:
                let currentVal = screen.value;
                let regex = /(\d+(\.\d+)?)(?!.*\d)/;
                let match = currentVal.match(regex);
                if(match) {
                    baseExp = match[0];
                    screen.value = currentVal.slice(0, match.index);
                } else {
                    baseExp = "";
                }
                expMode = true;
                expExponent = "";
                // Append the base with a blinking superscript cursor (underscore).
                screen.value += baseExp + toSuperscript("_");
                startExpCursor();
                updateScroll();
                return;
            }
            else if (btnText === "√" || btnText === "∛") {
                if(screen.value === "0") { screen.value = ""; }
                sqrtMode = true;
                sqrtRadicand = "";
                currentRoot = btnText;
                screen.value += currentRoot;
            }
            else {
                if(screen.value === "0") { screen.value = ""; }
                screen.value += btnText;
            }
            updateScroll();
        });
    });

    // Evaluate the expression.
    document.querySelector('.equal').addEventListener('click', function() {
        const screen = document.getElementById('calc-screen');
        let expression = screen.value;
        if(sqrtMode) {
            expression += ")";
            sqrtMode = false;
        }
        if(expMode) {
            stopExpCursor();
            // Replace the raised exponent (superscript digits) at the end with "**" operator.
            expression = expression.replace(/[⁰¹²³⁴⁵⁶⁷⁸⁹\.]+$/, function(match) {
                let normalExp = fromSuperscript(match);
                return "**" + normalExp;
            });
            expMode = false;
            baseExp = "";
            expExponent = "";
        }
        // Replace our sqrt/∛ notation with Math.sqrt/Math.cbrt calls.
        expression = expression.replace(/(√|∛)([0-9\u0305\.]+)\)/g, function(match, rootSymbol, radicand) {
            let plainRadicand = radicand.replace(/\u0305/g, "");
            return (rootSymbol === "√" ? "Math.sqrt(" : "Math.cbrt(") + plainRadicand + ")";
        });
        // Replace trig functions with Math. functions.
        expression = expression.replace(/asin\(/g, "Math.asin(")
            .replace(/sin\(/g, "Math.sin(")
            .replace(/cos\(/g, "Math.cos(")
            .replace(/tan\(/g, "Math.tan(");
        // Replace other symbols.
        expression = expression.replace(/×/g, '*')
            .replace(/÷/g, '/')
            .replace(/x\^y/g, '**')
            .replace(/²/g, "**2")
            .replace(/³/g, "**3");
        try {
            const result = eval(expression);
            if (!isFinite(result)) {
                screen.value = "Error";
                lastAns = "";
            } else {
                screen.value = result;
                lastAns = result;
            }
        } catch(e) {
            screen.value = "Error";
            lastAns = "";
        }
        evaluated = true;
        updateScroll();
    });
</script>
</body>
</html>
